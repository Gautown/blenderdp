---
import MainLayout from '../../layouts/MainLayout.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  // 获取所有内容的标签
  const allModels = await getCollection('models');
  const allTools = await getCollection('tools');
  const allStudyMaterials = await getCollection('study-materials');
  const allAssetLibraries = await getCollection('asset-library');

  // 提取所有标签
  const allTags = new Set<string>();

  // 处理模型标签
  allModels.forEach((item: any) => {
    if (item.data.tags && Array.isArray(item.data.tags)) {
      item.data.tags.forEach((tag: string) => allTags.add(tag));
    }
  });

  // 处理工具标签
  allTools.forEach((item: any) => {
    if (item.data.tags && Array.isArray(item.data.tags)) {
      item.data.tags.forEach((tag: string) => allTags.add(tag));
    }
  });

  // 处理学习资料标签
  allStudyMaterials.forEach((item: any) => {
    if (item.data.tags && Array.isArray(item.data.tags)) {
      item.data.tags.forEach((tag: string) => allTags.add(tag));
    }
  });

  // 处理资产库标签
  allAssetLibraries.forEach((item: any) => {
    if (item.data.tags && Array.isArray(item.data.tags)) {
      item.data.tags.forEach((tag: string) => allTags.add(tag));
    }
  });

  // 为每个标签生成路径
  return Array.from(allTags).map(tag => ({
    params: { tag },
  }));
}

const { tag } = Astro.params;

// 获取具有指定标签的所有内容
const allModels = await getCollection('models');
const allTools = await getCollection('tools');
const allStudyMaterials = await getCollection('study-materials');
const allAssetLibraries = await getCollection('asset-library');

// 筛选具有指定标签的内容
const modelItems = allModels.filter((item: any) => 
  item.data.tags && Array.isArray(item.data.tags) && (item.data.tags as string[]).includes(tag as string)
);

const toolItems = allTools.filter((item: any) => 
  item.data.tags && Array.isArray(item.data.tags) && (item.data.tags as string[]).includes(tag as string)
);

const studyMaterialItems = allStudyMaterials.filter((item: any) => 
  item.data.tags && Array.isArray(item.data.tags) && (item.data.tags as string[]).includes(tag as string)
);

const assetLibraryItems = allAssetLibraries.filter((item: any) => 
  item.data.tags && Array.isArray(item.data.tags) && (item.data.tags as string[]).includes(tag as string)
);

// 为不同类型的项目创建统一的结构
const unifiedModelItems = modelItems.map(item => ({ 
  ...item, 
  type: '模型',
  identifier: item.slug,
  collection: 'models'
})).filter(item => item.identifier !== 'example-model');

const unifiedToolItems = toolItems.map(item => ({ 
  ...item, 
  type: '工具',
  identifier: item.slug,
  collection: 'tools'
})).filter(item => item.identifier !== 'example-tool');

const unifiedStudyMaterialItems = studyMaterialItems.map(item => ({ 
  ...item, 
  type: '学习资料',
  identifier: item.id,
  collection: 'study-materials'
})).filter(item => item.identifier !== 'hello-world');

const unifiedAssetLibraryItems = assetLibraryItems.map(item => ({ 
  ...item, 
  type: '资产库',
  identifier: item.id,
  collection: 'asset-library'
})).filter(item => item.identifier !== 'example-asset-library');

// 合并所有内容并按日期排序
const allItems = [
  ...unifiedModelItems,
  ...unifiedToolItems,
  ...unifiedStudyMaterialItems,
  ...unifiedAssetLibraryItems
].sort((a, b) => {
  const dateA = a.data.date ? new Date(a.data.date).getTime() : 0;
  const dateB = b.data.date ? new Date(b.data.date).getTime() : 0;
  return dateB - dateA;
});
---

<MainLayout title={`标签: ${tag}`} description={`包含标签 "${tag}" 的所有内容`}>
  <div class="main-content">
    <h1 class="section-title">标签: {tag}</h1>
    
    {allItems.length > 0 ? (
      <div class="grid-5">
        {allItems.map((item) => (
          <a href={`/${item.collection}/${item.identifier}`} class="content-card" aria-label={`查看${item.type}：${item.data.title}`}>
            <div class="card-image">
              {item.data.thumbnail ? (
                <img 
                  src={item.data.thumbnail} 
                  alt={item.data.title}

                />
              ) : (
                <div class="placeholder-image">暂无图片</div>
              )}
            </div>
            <div class="card-content">
              <span class="card-tag">{item.type}</span>
              <h2 class="card-title">{item.data.title}</h2>
              <p class="card-date">
                {item.data.date ? new Date(item.data.date).toLocaleDateString('zh-CN') : '未知日期'}
              </p>
            </div>
          </a>
        ))}
      </div>
    ) : (
      <p>没有找到包含此标签的内容。</p>
    )}
  </div>
</MainLayout>