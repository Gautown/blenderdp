---
import ContentLayout from '../../layouts/ContentLayout.astro';
import Comments from '../../components/Comments.astro';
import { getCollection, getEntry, render } from 'astro:content';
import type { CollectionEntry } from 'astro:content';

export async function getStaticPaths() {
  const tools = await getCollection('tools');
  return tools.map(tool => ({
    params: { slug: tool.slug },
    props: { slug: tool.slug },
  }));
}

const { slug } = Astro.props;
const tool = await getEntry('tools', slug) as CollectionEntry<'tools'>;
const { Content } = await render(tool);

// 获取所有学习资料并按日期排序，获取最新的3篇
const allStudyMaterials = await getCollection('study-materials');
const sortedStudyMaterials = allStudyMaterials.sort((a, b) => {
  const dateA = a.data.date ? new Date(a.data.date).getTime() : 0;
  const dateB = b.data.date ? new Date(b.data.date).getTime() : 0;
  return dateB - dateA;
});
const latestStudyMaterials = sortedStudyMaterials.slice(0, 3);

// 获取随机推荐内容（示例数据）
const randomRecommendations = [
  { title: "推荐作品1", url: "/portfolio", type: "作品" },
  { title: "推荐工具1", url: "/tools", type: "工具" },
  { title: "推荐学习资料1", url: "/study-materials", type: "学习资料" },
];

// 获取最新文章（学习资料合集）
const latestArticles = latestStudyMaterials.map(studyMaterial => ({
  title: studyMaterial.data.title,
  url: `/study-materials/${studyMaterial.id}`,
  date: studyMaterial.data.date ? new Date(studyMaterial.data.date).toLocaleDateString('zh-CN') : '未知日期'
}));

// 获取热门标签（从实际内容中提取）
// 收集所有内容的标签
const allModels = await getCollection('models');
const allTools = await getCollection('tools');
// 修复：重命名变量以避免重复声明
const allStudyMaterialsForTags = await getCollection('study-materials');
const allAssetLibraries = await getCollection('asset-library');

// 提取所有标签并统计频率
const tagCounts = new Map();

// 处理模型标签
allModels.forEach(item => {
  if (item.data.tags && Array.isArray(item.data.tags)) {
    item.data.tags.forEach(tag => {
      tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
    });
  }
});

// 处理工具标签
allTools.forEach(item => {
  if (item.data.tags && Array.isArray(item.data.tags)) {
    item.data.tags.forEach(tag => {
      tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
    });
  }
});

// 处理学习资料标签
allStudyMaterialsForTags.forEach(item => {
  if (item.data.tags && Array.isArray(item.data.tags)) {
    item.data.tags.forEach((tag: string) => {
      tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
    });
  }
});

// 处理资产库标签
allAssetLibraries.forEach(item => {
  if (item.data.tags && Array.isArray(item.data.tags)) {
    item.data.tags.forEach((tag: string) => {
      tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
    });
  }
});

// 转换为数组并按频率排序，取前10个
const popularTags = Array.from(tagCounts.entries())
  .map(([name, count]) => ({ name, count, url: `/tags/${encodeURIComponent(name)}` }))
  .sort((a, b) => b.count - a.count)
  .slice(0, 10);
---

<ContentLayout 
  title={tool.data.title}
  description={tool.data.description}
  breadcrumbLinks={[
    { href: '/', label: '首页' },
    { href: '/tools', label: '工具' },
    { href: '#', label: '正文' }
  ]}
  randomRecommendations={randomRecommendations}
  latestArticles={latestArticles}
  popularTags={popularTags}
>
  <article class="model-detail">
    <h1>{tool.data.title}</h1>
    
    <div class="model-meta">
      <p>{tool.data.date ? new Date(tool.data.date).toLocaleDateString('zh-CN') : ''}</p>
    </div>
    
    {/* 显示标签 */}
    {tool.data.tags && tool.data.tags.length > 0 && (
      <div class="model-tags">
        <h3>标签：</h3>
        <div class="tag-list">
          {tool.data.tags.map(tag => (
            <span class="tag">{tag}</span>
          ))}
        </div>
      </div>
    )}
    
    {tool.data.thumbnail && (
      <img 
        src={tool.data.thumbnail} 
        alt={tool.data.title} 
        class="model-image"

      />
    )}
    
    <div class="model-content">
      <Content />
    </div>
  </article>
  
  <Comments />
</ContentLayout>

<!-- 所有样式已移至global.css -->